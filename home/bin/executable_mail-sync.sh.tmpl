#!/bin/sh

{{- if eq .chezmoi.hostname "torpedo" }}
/usr/bin/gmi sync -C ~/.mail/operas.gmail
{{- else }}

MBSYNC=$(pgrep mbsync)
NOTMUCH=$(pgrep notmuch)
AFEW=$(pgrep afew)

if [ -n "$MBSYNC" ] || [ -n "$NOTMUCH" ] || [ -n "$AFEW" ]; then
  echo "Already running one instance of mbsync, notmuch or afew. Exiting..."
  exit 0
fi

# TODO: check if programs are available

# Only run if notmuch DB is aleady initialized
if [ -d ~/Mail/.notmuch/xapian ]; then

  # Move tagged messages to the related folders (i.e. all, spam, sent or trash)
  afew --move --all

  # This can be used to definitely delete messages, skipping the trash
  # echo "Deleting local messages tagged as *deleted*"
  # notmuch search --format=text0 --output=files tag:deleted | xargs -0 --no-run-if-empty rm -v
fi

# Synchronize all mailboxes
mbsync --all

# Tag new messages, afew runs as post hook
notmuch new
{{- end }}
